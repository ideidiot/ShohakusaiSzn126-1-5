<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>整理券呼び出し - 松柏祭r71-5</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
    <style>
      body {
        padding: 40px;
      }
      #ticket-form {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 20px;
      }
      #ticket-number {
        padding: 10px;
        font-size: 1.2em;
        width: 200px;
        text-align: center;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      #call-button,
      .delete-button {
        padding: 12px 30px;
        font-size: 1.1em;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s;
      }
      #call-button:hover {
        background-color: #45a049;
      }
      #message {
        margin-top: 20px;
        font-weight: bold;
      }

      #current-tickets-container {
        margin-top: 40px;
        padding: 20px;
        border: 1px dashed #42a5f5;
        border-radius: 10px;
      }
      .ticket-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #eee;
      }
      .delete-button {
        background-color: #f44336;
        font-size: 0.8em;
        padding: 5px 10px;
      }
      .delete-button:hover {
        background-color: #d32f2f;
      }
    </style>
  </head>
  <body>
    <h1>整理券番号 呼び出し</h1>
    <form id="ticket-form">
      <input
        type="number"
        id="ticket-number"
        placeholder="新しい番号を入力"
        required
      />
      <button type="submit" id="call-button">番号を呼び出す</button>
    </form>
    <p id="message"></p>

    <div id="current-tickets-container">
      <h2>現在表示中の番号</h2>
      <div id="current-tickets-list"></div>
      <p id="no-tickets-message" style="display: none">
        現在表示中の番号はありません。
      </p>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="firebase-config.js"></script>

    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAKFXx_Lg3uVVHZPagCXfBOFNlfyi57FXs",
        authDomain: "shohakusaiszn126-1-5.firebaseapp.com",
        databaseURL: "https://shohakusaiszn126-1-5-default-rtdb.firebaseio.com",
        projectId: "shohakusaiszn126-1-5",
        storageBucket: "shohakusaiszn126-1-5.firebasestorage.app",
        messagingSenderId: "716915522027",
        appId: "1:716915522027:web:15de0202348ee194bd41ae",
        measurementId: "G-2R1T2P33L8",
      };

      firebase.initializeApp(firebaseConfig);
      const database = firebase.database();

      const form = document.getElementById("ticket-form");
      const ticketInput = document.getElementById("ticket-number");
      const messageElement = document.getElementById("message");
      const ticketsList = document.getElementById("current-tickets-list");
      const noTicketsMessage = document.getElementById("no-tickets-message");
      const ticketsRef = database.ref("calledTickets");

      // 新しい番号を追加する
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const ticketNumber = ticketInput.value.trim();
        if (ticketNumber === "") {
          messageElement.textContent = "整理券番号を入力してください。";
          messageElement.style.color = "red";
          return;
        }
        ticketsRef
          .push(ticketNumber)
          .then(() => {
            messageElement.textContent = `整理券番号「${ticketNumber}」を追加しました！`;
            messageElement.style.color = "green";
            ticketInput.value = "";
          })
          .catch((error) => {
            messageElement.textContent = "追加に失敗しました: " + error.message;
            messageElement.style.color = "red";
            console.error("更新エラー:", error);
          });
      });

      // データベースの変更を監視し、表示中の番号を更新する
      ticketsRef.on("value", (snapshot) => {
        const tickets = snapshot.val();
        ticketsList.innerHTML = "";
        if (tickets) {
          noTicketsMessage.style.display = "none";
          for (let key in tickets) {
            const ticketNumber = tickets[key];
            const ticketItem = document.createElement("div");
            ticketItem.className = "ticket-item";
            ticketItem.innerHTML = `
            <span>番号：${ticketNumber}</span>
            <button class="delete-button" data-key="${key}">削除</button>
          `;
            ticketsList.appendChild(ticketItem);
          }
        } else {
          noTicketsMessage.style.display = "block";
        }
      });

      // 削除ボタンのクリックイベント
      ticketsList.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete-button")) {
          const keyToDelete = e.target.getAttribute("data-key");
          const ticketRef = database.ref("calledTickets/" + keyToDelete);
          ticketRef
            .remove()
            .then(() => {
              messageElement.textContent = "番号を削除しました。";
              messageElement.style.color = "blue";
            })
            .catch((error) => {
              messageElement.textContent =
                "削除に失敗しました: " + error.message;
              messageElement.style.color = "red";
            });
        }
      });
    </script>
  </body>
</html>
